(*
https://adventofcode.com/2020/day/10
*)

open Printf

let input_test = [
    ('F', 10);
    ('N', 3);
    ('F', 7);
    ('R', 90);
    ('F', 11);
];;

let input = [
    ('W', 3);
    ('R', 180);
    ('S', 1);
    ('F', 2);
    ('R', 90);
    ('W', 3);
    ('F', 81);
    ('L', 270);
    ('W', 5);
    ('F', 30);
    ('R', 90);
    ('E', 5);
    ('S', 3);
    ('F', 44);
    ('R', 180);
    ('S', 4);
    ('F', 21);
    ('R', 270);
    ('F', 2);
    ('W', 3);
    ('F', 36);
    ('L', 90);
    ('S', 1);
    ('E', 3);
    ('F', 86);
    ('S', 2);
    ('F', 98);
    ('E', 4);
    ('F', 93);
    ('W', 5);
    ('R', 90);
    ('W', 5);
    ('F', 4);
    ('E', 4);
    ('F', 6);
    ('R', 90);
    ('N', 2);
    ('L', 90);
    ('F', 52);
    ('R', 90);
    ('W', 4);
    ('F', 30);
    ('E', 5);
    ('W', 5);
    ('N', 4);
    ('F', 1);
    ('N', 3);
    ('W', 2);
    ('F', 89);
    ('E', 1);
    ('L', 90);
    ('W', 1);
    ('R', 90);
    ('F', 67);
    ('N', 5);
    ('R', 90);
    ('F', 95);
    ('L', 90);
    ('E', 4);
    ('S', 4);
    ('E', 2);
    ('N', 4);
    ('E', 4);
    ('R', 90);
    ('R', 90);
    ('F', 99);
    ('W', 1);
    ('R', 90);
    ('E', 4);
    ('F', 26);
    ('W', 5);
    ('L', 90);
    ('F', 89);
    ('E', 2);
    ('F', 18);
    ('W', 3);
    ('L', 90);
    ('F', 64);
    ('N', 2);
    ('F', 69);
    ('L', 90);
    ('F', 81);
    ('R', 90);
    ('E', 4);
    ('L', 90);
    ('N', 5);
    ('E', 2);
    ('F', 25);
    ('W', 4);
    ('L', 180);
    ('N', 2);
    ('R', 90);
    ('F', 82);
    ('R', 90);
    ('S', 3);
    ('F', 64);
    ('E', 4);
    ('F', 11);
    ('R', 90);
    ('F', 93);
    ('E', 2);
    ('F', 18);
    ('L', 90);
    ('R', 180);
    ('F', 13);
    ('L', 90);
    ('F', 37);
    ('L', 90);
    ('F', 63);
    ('R', 90);
    ('W', 3);
    ('N', 2);
    ('E', 2);
    ('F', 90);
    ('E', 5);
    ('L', 90);
    ('F', 1);
    ('W', 1);
    ('S', 5);
    ('W', 2);
    ('E', 5);
    ('S', 1);
    ('L', 90);
    ('E', 3);
    ('N', 4);
    ('L', 180);
    ('F', 26);
    ('E', 1);
    ('L', 90);
    ('W', 3);
    ('L', 90);
    ('S', 5);
    ('R', 90);
    ('F', 40);
    ('N', 3);
    ('W', 2);
    ('F', 85);
    ('E', 1);
    ('R', 270);
    ('F', 87);
    ('W', 2);
    ('F', 87);
    ('N', 3);
    ('E', 1);
    ('S', 4);
    ('E', 3);
    ('W', 3);
    ('F', 55);
    ('S', 1);
    ('E', 2);
    ('N', 3);
    ('L', 90);
    ('F', 44);
    ('W', 4);
    ('L', 90);
    ('F', 5);
    ('S', 5);
    ('F', 97);
    ('S', 3);
    ('R', 90);
    ('S', 2);
    ('E', 4);
    ('N', 3);
    ('F', 39);
    ('W', 2);
    ('F', 43);
    ('N', 1);
    ('W', 1);
    ('N', 2);
    ('E', 1);
    ('L', 180);
    ('N', 2);
    ('W', 4);
    ('S', 2);
    ('W', 1);
    ('R', 180);
    ('E', 1);
    ('N', 1);
    ('F', 5);
    ('W', 2);
    ('S', 2);
    ('L', 90);
    ('E', 4);
    ('L', 90);
    ('N', 3);
    ('W', 4);
    ('L', 90);
    ('E', 3);
    ('E', 1);
    ('S', 5);
    ('E', 2);
    ('L', 180);
    ('F', 86);
    ('W', 1);
    ('L', 90);
    ('W', 5);
    ('L', 90);
    ('E', 4);
    ('F', 63);
    ('W', 5);
    ('R', 180);
    ('F', 98);
    ('E', 3);
    ('F', 67);
    ('W', 4);
    ('E', 2);
    ('N', 4);
    ('L', 90);
    ('E', 3);
    ('L', 90);
    ('F', 97);
    ('L', 90);
    ('F', 21);
    ('N', 1);
    ('R', 90);
    ('F', 34);
    ('L', 90);
    ('L', 180);
    ('F', 30);
    ('E', 4);
    ('N', 2);
    ('R', 180);
    ('N', 1);
    ('R', 180);
    ('N', 4);
    ('F', 77);
    ('L', 180);
    ('N', 5);
    ('S', 1);
    ('F', 81);
    ('W', 1);
    ('N', 5);
    ('F', 77);
    ('S', 2);
    ('W', 2);
    ('S', 4);
    ('E', 2);
    ('F', 19);
    ('R', 90);
    ('R', 90);
    ('N', 2);
    ('F', 57);
    ('S', 4);
    ('L', 90);
    ('W', 3);
    ('R', 90);
    ('N', 5);
    ('W', 3);
    ('F', 16);
    ('L', 90);
    ('E', 4);
    ('W', 2);
    ('S', 3);
    ('L', 90);
    ('N', 5);
    ('R', 90);
    ('F', 93);
    ('S', 3);
    ('W', 5);
    ('R', 90);
    ('F', 80);
    ('N', 4);
    ('R', 90);
    ('N', 1);
    ('F', 95);
    ('S', 3);
    ('R', 90);
    ('F', 38);
    ('R', 90);
    ('F', 81);
    ('E', 2);
    ('S', 1);
    ('E', 1);
    ('L', 90);
    ('N', 5);
    ('W', 2);
    ('L', 90);
    ('N', 1);
    ('R', 90);
    ('E', 5);
    ('F', 79);
    ('S', 3);
    ('E', 5);
    ('N', 3);
    ('F', 92);
    ('N', 2);
    ('W', 4);
    ('S', 3);
    ('L', 90);
    ('F', 79);
    ('W', 4);
    ('L', 90);
    ('F', 46);
    ('S', 4);
    ('L', 90);
    ('S', 5);
    ('R', 270);
    ('F', 33);
    ('W', 5);
    ('L', 90);
    ('F', 46);
    ('W', 5);
    ('R', 90);
    ('S', 3);
    ('R', 180);
    ('W', 4);
    ('E', 4);
    ('R', 180);
    ('F', 87);
    ('N', 5);
    ('F', 63);
    ('S', 2);
    ('E', 2);
    ('F', 35);
    ('W', 4);
    ('F', 19);
    ('R', 90);
    ('S', 3);
    ('E', 3);
    ('R', 180);
    ('E', 4);
    ('F', 14);
    ('E', 5);
    ('L', 270);
    ('F', 35);
    ('L', 180);
    ('F', 74);
    ('R', 90);
    ('S', 4);
    ('W', 1);
    ('F', 36);
    ('R', 90);
    ('S', 2);
    ('F', 1);
    ('L', 90);
    ('S', 4);
    ('F', 55);
    ('E', 4);
    ('N', 1);
    ('L', 90);
    ('S', 3);
    ('N', 3);
    ('W', 5);
    ('S', 4);
    ('L', 180);
    ('W', 1);
    ('S', 3);
    ('F', 30);
    ('S', 3);
    ('E', 2);
    ('F', 25);
    ('S', 4);
    ('F', 29);
    ('L', 90);
    ('W', 1);
    ('L', 90);
    ('F', 60);
    ('W', 2);
    ('S', 3);
    ('W', 1);
    ('S', 2);
    ('R', 90);
    ('F', 82);
    ('S', 5);
    ('L', 90);
    ('E', 4);
    ('R', 90);
    ('W', 1);
    ('F', 92);
    ('L', 90);
    ('F', 35);
    ('W', 4);
    ('F', 94);
    ('L', 90);
    ('F', 56);
    ('F', 52);
    ('L', 180);
    ('E', 2);
    ('S', 5);
    ('W', 1);
    ('L', 180);
    ('N', 3);
    ('E', 2);
    ('E', 1);
    ('F', 15);
    ('L', 90);
    ('F', 49);
    ('L', 180);
    ('F', 57);
    ('L', 180);
    ('F', 86);
    ('S', 1);
    ('R', 180);
    ('N', 3);
    ('F', 59);
    ('W', 4);
    ('F', 17);
    ('R', 90);
    ('W', 3);
    ('F', 7);
    ('L', 180);
    ('N', 3);
    ('L', 90);
    ('E', 3);
    ('F', 57);
    ('L', 180);
    ('W', 4);
    ('S', 1);
    ('L', 90);
    ('S', 3);
    ('F', 7);
    ('E', 2);
    ('S', 5);
    ('F', 36);
    ('E', 3);
    ('F', 87);
    ('L', 90);
    ('L', 180);
    ('F', 58);
    ('R', 90);
    ('N', 1);
    ('L', 270);
    ('F', 24);
    ('N', 5);
    ('F', 3);
    ('F', 65);
    ('S', 2);
    ('R', 90);
    ('F', 62);
    ('L', 270);
    ('F', 94);
    ('E', 5);
    ('N', 2);
    ('F', 79);
    ('R', 90);
    ('E', 4);
    ('F', 43);
    ('W', 5);
    ('N', 3);
    ('F', 81);
    ('N', 5);
    ('R', 90);
    ('F', 22);
    ('W', 2);
    ('R', 180);
    ('N', 2);
    ('L', 90);
    ('E', 5);
    ('F', 39);
    ('E', 4);
    ('F', 8);
    ('W', 4);
    ('N', 4);
    ('W', 4);
    ('S', 4);
    ('L', 90);
    ('S', 1);
    ('L', 180);
    ('W', 3);
    ('L', 90);
    ('N', 1);
    ('R', 90);
    ('W', 4);
    ('R', 90);
    ('F', 7);
    ('W', 4);
    ('F', 40);
    ('E', 5);
    ('L', 90);
    ('R', 270);
    ('E', 4);
    ('R', 90);
    ('F', 34);
    ('W', 2);
    ('R', 90);
    ('N', 2);
    ('L', 90);
    ('F', 45);
    ('R', 90);
    ('E', 5);
    ('R', 90);
    ('N', 2);
    ('F', 11);
    ('L', 90);
    ('F', 80);
    ('S', 2);
    ('E', 2);
    ('R', 180);
    ('E', 2);
    ('L', 180);
    ('S', 1);
    ('F', 39);
    ('L', 180);
    ('N', 4);
    ('F', 99);
    ('R', 270);
    ('W', 4);
    ('L', 90);
    ('R', 90);
    ('W', 1);
    ('E', 1);
    ('S', 5);
    ('R', 90);
    ('F', 91);
    ('W', 4);
    ('F', 93);
    ('L', 180);
    ('E', 1);
    ('F', 15);
    ('N', 2);
    ('R', 90);
    ('W', 4);
    ('F', 26);
    ('S', 2);
    ('R', 90);
    ('N', 5);
    ('L', 90);
    ('N', 4);
    ('W', 4);
    ('S', 3);
    ('F', 25);
    ('E', 4);
    ('F', 38);
    ('L', 90);
    ('W', 1);
    ('F', 86);
    ('E', 5);
    ('L', 90);
    ('W', 5);
    ('L', 90);
    ('F', 21);
    ('W', 2);
    ('F', 99);
    ('L', 90);
    ('N', 4);
    ('L', 180);
    ('F', 40);
    ('S', 2);
    ('W', 4);
    ('F', 70);
    ('W', 3);
    ('F', 32);
    ('N', 1);
    ('W', 1);
    ('L', 90);
    ('N', 5);
    ('R', 90);
    ('W', 3);
    ('F', 99);
    ('W', 3);
    ('N', 2);
    ('R', 90);
    ('S', 3);
    ('E', 2);
    ('L', 90);
    ('N', 5);
    ('F', 36);
    ('S', 1);
    ('L', 180);
    ('W', 4);
    ('S', 5);
    ('E', 4);
    ('F', 54);
    ('L', 90);
    ('S', 5);
    ('E', 2);
    ('L', 90);
    ('F', 14);
    ('W', 1);
    ('N', 1);
    ('R', 90);
    ('S', 5);
    ('E', 4);
    ('F', 32);
    ('R', 90);
    ('N', 1);
    ('F', 23);
    ('E', 4);
    ('N', 4);
    ('W', 4);
    ('F', 57);
    ('N', 2);
    ('R', 180);
    ('E', 2);
    ('S', 4);
    ('F', 70);
    ('L', 90);
    ('W', 4);
    ('S', 3);
    ('F', 57);
    ('L', 90);
    ('E', 3);
    ('N', 5);
    ('R', 90);
    ('N', 4);
    ('W', 4);
    ('N', 5);
    ('W', 5);
    ('R', 90);
    ('W', 4);
    ('R', 90);
    ('E', 3);
    ('L', 90);
    ('N', 2);
    ('F', 93);
    ('L', 90);
    ('R', 180);
    ('S', 4);
    ('F', 28);
    ('E', 3);
    ('R', 90);
    ('S', 2);
    ('E', 3);
    ('R', 90);
    ('L', 90);
    ('F', 49);
    ('R', 180);
    ('F', 12);
    ('L', 180);
    ('N', 4);
    ('R', 180);
    ('S', 4);
    ('R', 90);
    ('S', 5);
    ('R', 90);
    ('F', 96);
    ('N', 4);
    ('F', 14);
    ('L', 90);
    ('S', 1);
    ('E', 2);
    ('L', 90);
    ('N', 3);
    ('R', 90);
    ('E', 2);
    ('W', 2);
    ('L', 180);
    ('N', 4);
    ('R', 90);
    ('W', 3);
    ('L', 90);
    ('N', 4);
    ('F', 69);
    ('E', 1);
    ('L', 90);
    ('S', 3);
    ('F', 62);
    ('R', 180);
    ('N', 3);
    ('F', 64);
    ('W', 1);
    ('S', 4);
    ('E', 1);
    ('L', 90);
    ('S', 3);
    ('F', 85);
    ('E', 2);
    ('L', 90);
    ('W', 3);
    ('R', 90);
    ('F', 92);
    ('N', 5);
    ('W', 2);
    ('N', 1);
    ('W', 1);
    ('R', 90);
    ('F', 1);
    ('R', 90);
    ('E', 2);
    ('R', 90);
    ('F', 34);
    ('N', 5);
    ('E', 2);
    ('N', 2);
    ('F', 79);
    ('L', 180);
    ('F', 63);
    ('L', 90);
    ('W', 2);
    ('F', 16);
    ('F', 81);
    ('S', 1);
    ('R', 180);
    ('F', 52);
    ('N', 4);
    ('W', 1);
    ('S', 3);
    ('R', 90);
    ('F', 58);
    ('E', 5);
    ('F', 99);
    ('W', 4);
    ('N', 3);
    ('L', 90);
    ('W', 4);
    ('F', 39);
    ('S', 2);
    ('F', 12);
    ('S', 1);
    ('W', 5);
    ('S', 2);
    ('F', 30);
    ('E', 2);
    ('F', 21);
    ('E', 2);
    ('N', 2);
    ('W', 5);
    ('L', 90);
    ('N', 1);
    ('W', 1);
    ('W', 3);
    ('N', 5);
    ('F', 65);
    ('S', 1);
    ('L', 180);
    ('F', 94);
    ('W', 1);
    ('L', 90);
    ('S', 2);
    ('E', 5);
    ('N', 3);
    ('F', 46);
    ('L', 180);
    ('S', 3);
    ('F', 1);
    ('L', 90);
    ('F', 77);
    ('N', 3);
    ('F', 36);
    ('N', 2);
    ('R', 90);
    ('F', 54);
    ('F', 65);
    ('N', 4);
    ('F', 99);
    ('E', 5);
    ('L', 180);
    ('E', 4);
    ('S', 3);
    ('E', 1);
    ('F', 83);
    ('E', 4);
    ('F', 50);
    ('N', 2);
    ('W', 2);
    ('R', 180);
    ('W', 5);
    ('R', 90);
    ('F', 96);
    ('L', 90);
    ('F', 7);
    ('E', 4);
    ('W', 2);
    ('F', 11);
    ('L', 180);
    ('N', 5);
    ('L', 180);
    ('S', 1);
    ('F', 92);
    ('S', 3);
    ('F', 3);
];;

let solve lst =
    let rec do_step (x, y, wpx, wpy) (op, arg) =
        let rec do_step (x, y, wpx, wpy) count =
            if count = 0 then
                (x, y, wpx, wpy)
            else
                do_step (x + wpx, y + wpy, wpx, wpy) (count - 1) in

        let rotate_wp angle =
            match angle with
            | 0 -> (x, y, wpx, wpy)
            | 90 -> (x, y, wpy, -wpx)
            | 180 -> (x, y, -wpx, -wpy)
            | 270 -> (x, y, -wpy, wpx)
            | x -> raise (Invalid_argument (string_of_int x)) in

        printf "(%d, %d, %d, %d) -> (%c, %d)\n" x y wpx wpy op arg;
        match op with
        | 'N' -> (x, y, wpx, wpy + arg)
        | 'S' -> (x, y, wpx, wpy - arg)
        | 'E' -> (x, y, wpx + arg, wpy)
        | 'W' -> (x, y, wpx - arg, wpy)
        | 'L' -> rotate_wp (360 - arg)
        | 'R' -> rotate_wp arg
        | 'F' -> do_step (x, y, wpx, wpy) arg
        | x -> raise (Invalid_argument "illegal op") in

    let (x, y, _, _) = List.fold_left do_step (0, 0, 10, 1) lst in
    (x, y)
;;

let (x, y) = solve input in
printf "%d + %d = %d\n" x y ((abs x) + (abs y));;
