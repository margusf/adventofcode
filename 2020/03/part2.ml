(*
https://adventofcode.com/2020/day/3
*)

open Array

let trees_test = [
    "..##.......";
    "#...#...#..";
    ".#....#..#.";
    "..#.#...#.#";
    ".#...##..#.";
    "..#.##.....";
    ".#.#.#....#";
    ".#........#";
    "#.##...#...";
    "#...##....#";
    ".#..#...#.#"
];;

let trees = [
    "......#..........##......#.####";
    ".##...###....#.....#...#.#.....";
    "#..##..#.....#............#.#.#";
    "##.#....#####..#....#..#.#.....";
    "..#.#...##.##.......#.#..#..##.";
    "##.#.......#.#.#..#...#.#...#..";
    "...#...#..#.##....##..#.#......";
    ".......##.#.#.#.##...#.........";
    "..#...##.##...##..##.##...#....";
    ".#.#...#.....####..#.#...#.##..";
    ".#...#......##......##....#....";
    "..#.....#.........##.#...#.#...";
    "...#.#...#..##...#....#.....##.";
    "..#.....#..#..#......###.......";
    "...##.#....##..##...........#..";
    "....#......#..#....###...#.....";
    ".....#...#.#.....#..##........#";
    "....#...#....##.#.##.#...#..#.#";
    ".......##.#......##....#....#..";
    "...#.#...##..#...#..#..#..##.#.";
    "##.#...#..#..................##";
    "##........#....##...#..#..#....";
    ".#.#..............#######.##...";
    "##..#..#.#.##..#...............";
    "..#........#..#...##.......#...";
    "............##.##.#..........##";
    ".....##..#.....##..#.....#.....";
    "..#.##.###.#..##.............#.";
    ".........##...........#.....#..";
    "..#....#.#.###.#.#.......##....";
    "..###..##..#.#.##......#.#.##..";
    "##......#.#....##.#..#.#..#.#.#";
    "..##.#.###.#...#...............";
    "..####.......#...#.##....#.....";
    "..#....##...#.#.#.#....#.##..##";
    ".#...####..###....#.###...##...";
    "..#.#..........#.#..#..#.....##";
    ".#....#.........###...#.....##.";
    "..#.#.#.##........#.##.#.....#.";
    "#....#....###...#..#.........#.";
    "#..#.###....#..............#...";
    "............#....##.#......#.#.";
    "...#..#.####...............##..";
    "....##......#.#.........####..#";
    ".#....###..#.#..##........##...";
    "#..##.....###..#...............";
    "..#...........#........#...#..#";
    "......................#.#..#...";
    ".#.##.#..#.#....#...#...#.#....";
    "..#..#.........#..#.#..........";
    ".#......#####...#......#..#....";
    "..........#.....#..#.##.####.##";
    "##.##..#............#####...#.#";
    "..##..#..###......#...#...#....";
    "....#####........#.##...###....";
    "......#...##..#..#............#";
    "...#....##.##...#..#...#.......";
    "....#####.#...............###..";
    ".#....#..##....#.#.#..##.##...#";
    "...#..#..#........#.#####.....#";
    "......##.#...#..#..#.....#..###";
    "###.......#.#........#......#.#";
    "..#.#..#..#........#..#......#.";
    "...##.........#..........#.....";
    "...#..###.#.......#.#.........#";
    "....#..#.##...##.....#.....##..";
    "#.#.#.#.....##.##.###..#.#....#";
    "..#....#.....##.####..#........";
    "...#..#.##.....##.#..#....###..";
    ".#..#.....#....#...#.#.......##";
    "..#..#.......#.#.###......#.##.";
    ".###.####....##............##.#";
    "#....###.#......##.#......##.#.";
    ".##...........#.#....#.........";
    "#.##..##...#...........###....#";
    "#.#..#...#.#..#..###.#.##...#..";
    "..#...#.#..##....#..#..#.......";
    "#..##..#.####...#...#..####.##.";
    "###..#.##....#...#.###..##...##";
    "##..#..#.#....#.....##.......#.";
    "..#..##.##.#.......###.#.....#.";
    "..........#.####....#.......#..";
    "#...#.#..#.......##......##..##";
    "##...##.##..###...............#";
    "....##.#...#.......##...##..#..";
    ".#.........#...#.#...##.#.....#";
    ".#...#.#..#...#..##....#..#...#";
    ".#.#...#..#..###...##....#.....";
    ".........#.#...####..#...#.#...";
    "...#.............#.#..........#";
    "...#...#..##.#........#.#......";
    "...#...#.....#....#..###.##.###";
    ".#.#........#....#...#.###.#.#.";
    "##.....#.......#..##.#....#..##";
    "...###...#.#.#.#....#.#....#...";
    "#...#.#.......##.#..#....#.#...";
    "#...#......###.....###........#";
    "..#.##...##....#...#....#.#....";
    "#....#..###....##.#......##...#";
    "##.#...#..........#.##....#..#.";
    ".##....#............###.#...#..";
    "###.##.#####.##.....##..#####..";
    "..###.###.......#.#...#....#...";
    ".#...#....####.........#.......";
    "..##.#.#......#....#.#....#.#.#";
    "#.####.....#....#..#.....#.##..";
    "###.###.##...##.#.#.#.....#.#..";
    ".......#.....#.......##.#.....#";
    "#..#.##...#........#.#.......##";
    "#.#........#...#....#..........";
    "..#....##.#......#..#..........";
    "#....##.....#.....#.##.#...#...";
    "....#.#.....#....####...#.#.##.";
    "......#.......##...##.#......#.";
    ".#.........##...#..#..##..#....";
    ".#...##.....##.#....#..........";
    "....#.###..##..#...#..........#";
    "......#...#.#.#........##......";
    ".#..........#.#.....#..##..#.#.";
    ".......###.#......#....#.#..#..";
    "..##.......#....#....#.#...##.#";
    "#.##.#.......#..###..##...#.#..";
    "......####....#.#.....#...#..#.";
    "#.##.###..#..#.#.....###..#.#.#";
    "#.#.#..#.#..##...#...#..##.###.";
    "....##..##.#...............#.#.";
    "..###.#.#.##..#....##.......#..";
    "#.#....#..........##......#####";
    ".#.#.......##.#.#......##..#.#.";
    "......#.###.##.#..#....#.##....";
    "..###........#.......##.#.#....";
    ".#..##.............#.##.###...#";
    ".#####...#......#.......##.....";
    "##..###.#...#....#..#....#.#..#";
    ".#.........###.##.....##.....##";
    ".##.#....#..#.#..##..#....##...";
    ".#..#..#......###...#.......#..";
    "#.#...#.....#..#.#.#..#..###...";
    "....#....#..#..#....#..#.#.#...";
    "......#.......#.#.#.#.....#....";
    "###...#...#......#..#.#.#..#.#.";
    "#...##.##.##........##....#....";
    ".....#.......#...#...#.#.#....#";
    "...##.....##.#...#.#.#.#..#..#.";
    ".#.......##...........#...#.##.";
    ".##..........#......#.#...###..";
    ".....##...#.....#...#......#...";
    "...........#.....#..#...#..#.#.";
    "#.....##..#...........##....#..";
    "#.##...###.###....##..#..#....#";
    "#.#.##...##....###....##.##....";
    ".#..###.....#......#...#...#..#";
    "..#...#....#.#.###.#..#......#.";
    "......#.........#..#.##...#...#";
    "..#.#....##.#..##..##...#....#.";
    "#.....#....##.........##.#.....";
    "...#...#..###.###......##...###";
    ".##.###...##..#.##....##.#..#..";
    "..#..#.......#................#";
    ".....#..#.#.#..........##..#...";
    "......###.#.#............#..#.#";
    "..#.##.....##....#...#...#.#...";
    "..#......##...#...##........#..";
    "#.....#.....#..#......#.###...#";
    "....#..#.#.....#...#....#.#...#";
    "#.......#..#...##..#.#..#.##...";
    "..#......###...#.........##...#";
    "...#.......##.....#..##........";
    ".#....#.#.....##.#.#...........";
    "##..#..#...#.##.#.#.#.#.#..##.#";
    "##...####.#.#.##...#..#......#.";
    "#.##..####.##.#.........#...###";
    "#...#.......#.#..####.#.#.#....";
    "#....#........#........#.......";
    "..#..####.....#....##...###.##.";
    "...#.#..####.........#....#.##.";
    "##.#...#...#..#.#..##.....##...";
    "....#.........#.##........##.#.";
    "##...#......#....#..#....#....#";
    "###.....#......##...#...##...#.";
    "#.##...............#.......#...";
    ".##.#...#..#....#.#.....###..#.";
    ".....##...#.##.....##...#....#.";
    "#.#..#..........#####..##......";
    "..#.........##...#.........#.##";
    "...#..##.#.#..#......#..###.###";
    "#..#...#.#...##..........#.....";
    ".###..#....###.....#....#..###.";
    "#..#....#...#........##.....#..";
    ".#..###........#....#..####..##";
    ".#..#.#.#.......##.#..##.#..##.";
    "..#..###......##....#..#..#..#.";
    ".......###..##....#......#...##";
    "#........#.##.............##.#.";
    "...#.#.#....##....##.###...#...";
    "..#.....#..##..#.#.......#.####";
    ".#......##.........##...#.....#";
    ".#.###........##....###.#.#...#";
    "##...#.#....#.....##.......#..#";
    "#...........#...........####...";
    "#..#.#..##..#...#....#.##....#.";
    "................##.............";
    "..##...#.#....##....#...#......";
    ".#.....#....#....#..#..#.#..##.";
    ".....######.#.#.##.###.#.......";
    "..#####....#..#...........#.#..";
    ".......#..#..##.#...###.#.#.###";
    "###...#...#..##.#.##..#...#..#.";
    ".#..#..............#...........";
    ".#.....#.....##....#....##..#..";
    "....#####.#....#......#.......#";
    ".#.#.....##.####..#...#.......#";
    ".#...##.#.......#.....##.#..##.";
    "..........#...#....###....#...#";
    "..#......#...#...#..#.#........";
    ".......#.......#..####..##.....";
    ".#..#.....###...#...#...#...#..";
    "##..#.......#.#...#..#..#.##..#";
    "#..#...#.#.....#.##.#........#.";
    "......#......#.#..###.##..###..";
    ".#..#..#.##.#...........#...##.";
    ".#....#...#.#..#.#.#...##.#..#.";
    "##.#....#..#..#.#...#......#.#.";
    "..#.#............##...#........";
    "...####...#...#.....##..#...###";
    "....###.......###.##..#.###....";
    "#......#.#....#.#.##.#.##..###.";
    ".....##.....#..##.....##....#..";
    "..#...#..##.#.##.#.#.#.......##";
    "#....#..##.......#......#..#.##";
    "#.....##...#..##......##.#.#..#";
    "....#..##..#.##...#.#.##..#..##";
    "#..#...##....##..#...#....#...#";
    ".##.#.#....#.....#........##.#.";
    "..##..#....#........#.....#....";
    ".##.#..##...#.....#...###.....#";
    "#..#..#........#..#.....#.#.#.#";
    "..##..###.#..#...#.#......#..#.";
    "#.....#.....#.###......##..#.#.";
    ".........#...##.........#...#..";
    ".##.#.##......#.#...###..#....#";
    "...##.#..###........##......#..";
    "...#.#...#......#.#.#....#..#..";
    "..####.........#..#....#.......";
    "#..#.........##.#.##....#.....#";
    "..#..#..#.#........#.###.......";
    "##.#..#..#....#...##.......#..#";
    "..#.#.....#.............#...##.";
    "..........#...##.....#..#.#..#.";
    "....#..#...#..##..#...##.#.....";
    "##....#......#..#.....#..#.....";
    "...#.#.#.#...........##...#.#..";
    "....#.###...#............#.....";
    ".#.#.#.......#.#......#....#.#.";
    "#.#.#.#..##.#..#..##...##.#..#.";
    ".#.##....##..#........#....#...";
    "####...#....#.#...#..#..###...#";
    ".....#.#.##.......##..#.######.";
    ".......#.#.#.....#.#..##....#..";
    "..#....#.#..#.#.#..#..#........";
    ".....##......#.........#.#...##";
    "#....##.#.....#..........#.#...";
    "#...#.#..#.#..#.#....#..#.#....";
    "....##........#................";
    "###.#.#...#..##...#...#.##...#.";
    "...#....###..#..##..#..#.......";
    ".....#..........#.#........##.#";
    ".#........#.##.#..##..#...#...#";
    "..##....#...#.#.........##.#...";
    "......#...#......#.....#.......";
    "....##.##..#.##...#.#.#.##.#.#.";
    "..#...#.....#.#....##.#........";
    ".#.#.......#.......###..#..#...";
    "#...#..#..#..##....#...#.....#.";
    ".#..####.##.....##.........#.#.";
    "#...###.......#...####..##.....";
    "#.##.#....#.#.##.......#...#...";
    "..#.......#.#.##.##..#...##....";
    ".#.......#.#..#.....#.....#.#..";
    "..#..#.......##.....#.#.....#.#";
    "#...###..#..#..##...#.....#..##";
    "......#................#.......";
    "..#.....##..#.......#...#...##.";
    "...##...####.#..#...#.......##.";
    "..#...#..#...#...#..#..#####...";
    "#..#...#....#....#...........#.";
    "..#.......#..#.##...##..###...#";
    ".#..#..#......##...#....#......";
    "...#..##....#..........#.....#.";
    "###...#.#......#.#.....#.....##";
    "#.#..#.....#........#.##.#.##..";
    "....#...#.....#..#.......#.#...";
    "#.#...##....#..#.....#...#.#.#.";
    ".#......#...##..#.......#......";
    "...#...#.#.#.###.#..#.#..#.....";
    "###...#..###.#...#..##...####..";
    ".#.#.#..#........#..#......#..#";
    ".#..#....#......#....#.#...#...";
    ".##..........###...##.....#.#..";
    ".#...#.#.##.##..###.#...#..###.";
    "......#......#......#.##......#";
    "..#.##..#.#..#....##..##...#...";
    ".#......#..#...##....#...#.....";
    ".#.....#.##..........#..#......";
    "###.#..#.##..#..##...#..#...#..";
    "#.....###........#.#..##.#.....";
    ".....#.......##.....##.....#.##";
    "...##.#......####....##........";
    "..#..#..#....#.##.....##.####..";
    "...#..#....#.#..#.#..#.#.#..#..";
    "#..........#....#.#.#.#...#..#.";
    "...####.##...#..#.......#.#..##";
    "#........#..#..................";
    ".#..#....#.#.#..#..........#...";
    "###...#....####....#......#..#.";
    "#.........####..#..#...........";
    ".....##..#..##.##.##.#..#.....#";
    ".#..#.#.##..#..#.#.#.##.###....";
    "......##......#...#.##....#..#.";
    ".#.#....#..#......#..#...###...";
    ".##...#......##...###...#.#...#";
    ".......#.#....#............#..#";
    ".#..##.#.######...#...#......#."
];;


let count_hits arr move_fun =
    let width = String.length (get arr 0) in

    let clean_pos (posx, posy) =
        (posx mod width, posy) in

    let is_hit (posx, posy) =
        let str = get arr posy in
        let c = String.get str posx in
        match c with
        | '#' -> 1
        | '.' -> 0
        | _ -> raise (Invalid_argument "Cannot happen") in

    let rec iter (posx, posy) result =
        let pos = (posx, posy) in
        if posy >= (length arr) then
            result
        else
            iter (clean_pos (move_fun pos)) (result + is_hit pos) in

    iter (0, 0) 0
;;

let hits = count_hits (of_list trees);;

let slope1 = hits (fun (x, y) -> (x + 1, y + 1));;
let slope2 = hits (fun (x, y) -> (x + 3, y + 1));;
let slope3 = hits (fun (x, y) -> (x + 5, y + 1));;
let slope4 = hits (fun (x, y) -> (x + 7, y + 1));;
let slope5 = hits (fun (x, y) -> (x + 1, y + 2));;

Printf.printf "%d * %d * %d * %d * %d = %d\n" slope1 slope2 slope3 slope4 slope5
        (slope1 * slope2 * slope3 * slope4 * slope5);;
